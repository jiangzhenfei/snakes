<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="./style.css">
    <script src="./node_modules/jquery/dist/jquery.min.js"></script>
    <script src="./node_modules/socket.io-client/dist/socket.io.js"></script>
</head>
<body>
    <div id="screen" class="container">
       
        <div class="moveContainer">
            <div class="touchBk"></div>
            <div class="touch"></div>
        </div>
    </div>
    <script>
        
        let ancle = Math.atan(1/Math.sqrt(3))//先求x和y的正切
        let y= Math.sin( ancle )//x一秒距离
        let x= Math.cos( ancle )//x一秒距离
        
        var obj = document.querySelector('.moveContainer .touch')
        var screen = document.querySelector('.moveContainer')
        var snack = document.querySelector('.header')
        let v = 1;
        
        let containerTop = screen.offsetTop;
        let containerLeft = screen.offsetLeft-50;
       
        
        screen.addEventListener('touchmove',function(e){
            e.preventDefault(); //阻止触摸时浏览器的缩放、滚动条滚动等  
            var touch = e.targetTouches[0];
            // 把元素放在手指所在的位置
            obj.style.left = touch.pageX-containerLeft + 'px';
            obj.style.top = touch.pageY-containerTop + 'px';
            let x = touch.pageX-containerLeft-50;
            let y = touch.pageY-containerTop-50;
            let l = Math.sqrt( x*x + y*y )
            let X = x/l;
            let Y = y/l;
            s.setXY(X,Y)
        })
        
        //蛇内的每一个组成单位
        function DotEle(start,header){
           this.start = start
           this.header = header;
           this.init()
           
        }
        DotEle.prototype.init = function(){
            if( this.header ){
                this.html = $('<div class="snack header"></div>')
                $('#screen').append(this.html)
            }else{
                this.html = $('<div class="snack"></div>')
                $('#screen').append(this.html)
            }
            
        }
        DotEle.prototype.setPositon = function(x,y){
            this.html.css({
                left:x,
                top:y
            })
        }
        DotEle.prototype.changeIndex = function(l){
            this.start++;
            if( this.start >= l){
                this.start = l;
            }
        }
        
        //蛇
        function Snack(){
            this.x = 0;
            this.y = 1;
            //蛇的所有走过的路径
            this.position = [];
            //蛇拥有的关节
            this.dot = [];
            this.init()
        }
        Snack.prototype.init = function(){
            this.initHeader()
            this.animate()
            setInterval(()=>{
                let d = new DotEle( 0 )
                d.setPositon( this.position[0][0],this.position[0][1] )
                this.dot.push( d )
            },5000)
        }
        //初始化头部
        Snack.prototype.initHeader = function(){
            this.header = new DotEle(0,'header')
            this.dot.push( this.header )
        }
        //设置x和y的分速度
        Snack.prototype.setXY = function(x,y){
            if(x==0 && y==0){
                return;
            }
            this.x = x;
            this.y = y;
        }
        //蛇运动轨迹（由每个关节组成）
        Snack.prototype.animate = function(){
            setInterval(()=>{
                //获取头部的轨迹信息
                let x = parseFloat(this.header.html.css('left')) + this.x*v
                let y = parseFloat(this.header.html.css('top')) + this.y*v
                if( this.position.length < this.dot.length * 10){
                    this.position.push([x,y])
                    for( var i = 0;i < this.dot.length; i++ ){
                        let dot = this.dot[i]
                        this.dotUpdate( dot )
                        dot.changeIndex(this.position.length -1 )
                    }
                }else{
                    this.position.push([x,y])
                    this.position.shift()
                    for( var i = 0;i < this.dot.length; i++ ){
                        let dot = this.dot[i]
                        this.dotUpdate( dot )
                    }
                }
                
            },19)
        }
        //关节位置更新
        Snack.prototype.dotUpdate = function(dot){
            let start = dot.start;
            let x = this.position[start][0]
            let y = this.position[start][1]
            dot.setPositon(x,y) 
        }
        let s =  new Snack()
       
        

       
       






        $('.btn').click( function(){
            window.room = $('.room').val();
            $.ajax({
                url:`http://localhost:8000?room=${$('.room').val()}`,
                success:(e)=>{
                    console.log(e)
                    let room = e.room;
                    window.news = io.connect(`http://localhost:8033/${room}`);
                    news.on('news', function (e) {
                        console.log(e)
                    });
                }
            })
        } )

        $('.btn2').click( function(){
            news.emit('fei','loading...')
        } )
    </script>
</body>
</html>